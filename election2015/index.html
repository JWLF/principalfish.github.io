<!DOCTYPE html>
<meta charset="utf-8">
<head>
	<title>UK Election Maps</title>
	<link type="text/css" rel="stylesheet" href="main.css"/>
	<link rel="shortcut icon" href="img/logo.png">
</head>

<body>	
	<script type="text/javascript" src="/js/d3.min.js"></script>
	<script type="text/javascript" src="/js/topojson.js"></script>	
	<script type="text/javascript" src="/js/dictionary.js"></script>
	<script type="text/javascript" src="/js/jquery-2.1.3.min.js"></script>
	<script type="text/javascript" src="/js/papaparse.min.js"></script>
	
		
	
		<div id="wrapper">
			<div id="top">
				<h2>Election 2015</h2>
				<div id="menu">
				  <ul>
					<li><a href="/" class="current">home</a></li>					
					<li><a href="mailto:principalfish@gmail.com" class="current">email</a></li>
				  </ul>
				</div>
			 </div>
			 
			 <div id ="farleft">
				<div id ="resetbutton">
					<button id ="resetzoom" onclick="reset()">Reset Zoom</button>
				</div>
				
				<div id="projections">
					<h2>Projections</h2>
					<h3 id="currentparliament"> Current Parliament </h3>
					<h3 id="2015projection"> 2015 Projection</h3>
				</div>
				
				<script>
						$("#currentparliament").click(function(){
						});
						
						$("#2015projection").click(function(){
							alert("nothing here yet");
							/*g.selectAll(".map")
								.remove()*/		
						});
				</script>
				
				<div id="filters">
					
					<h2> Filters <button id ="filterbutton" onclick="resetFilter()">Reset</button></h2>	
					
					
					
					<p> by party </p>
					 <select id="dropdownparty" onchange="filterStates[0].party = value, filterMap()">
						<option value="null"></option>
						<option value="labour">Labour</option>
						<option value="conservative">Conservative</option>
						<option value="libdems">Liberal Democrats</option>
						<option value="ukip">UKIP</option>
						<option value="snp">SNP</option>
						<option value="plaidcymru">Plaid Cymru</option>
						<option value="green">Green</option>
						<option value="respect">Respect</option>			
						<option value="independent">Independent</option>	
						<option value="speaker">Speaker</option>						
					</select> 
					
					<p> by majority</p>
					<select id="dropdownmajority" onchange="filterStates[1].majority = value, filterMap()">
						<option value="null"></option>
						<option value="marginal"> < 1000 </option>
						<option value="close">1000-2999</option>
						<option value="safeish">3000-6999</option>
						<option value="safe"> > 7000</option>										
					</select> 
					 
					
					<p> by region </p>
					<select id="dropdownregion" onchange="filterStates[2].region = value, filterMap()">
						<option value="null"></option>
						<option value="eastofengland">East of England</option>
						<option value="eastmidlands"> East Midlands </option>
						<option value="london">London</option>
						<option value="northeastengland">North East England</option>
						<option value="northwestengland">North West England</option>
						<option value="scotland">Scotland</option>
						<option value="southeastengland">South East England</option>
						<option value="southwestengland">South West England</option>
						<option value="westmidlands">West Midlands</option>
						<option value="wales">Wales</option>	
						<option value="yorkshireandthehumber">Yorkshire & Humber</option>	
					</select> 
					
				
					<p> by turnout </p>
					<select id="dropdownturnout" onchange="filterStates[3].turnout = value, filterMap()">
						<option value="null"></option>
						<option value="low"><55%</option>				
						<option value="average">55-65%</option>
						<option value="high">65-75%</option>
						<option value="extreme">>75%</option>
					</select> 
				</div>
				
				<script>
				
					filterStates = [{party: "null"}, {majority: "null"}, {region: "null"}, {turnout: "null"}]
					
					function filterMap(){
					
						var	party  = filterStates[0].party;
						var majority = filterStates[1].majority;
						var region = filterStates[2].region;
						var turnout =  filterStates[3].turnout;
						
											
						d3.json("map.json", function(uk){
							
							if (party == "null" && majority == "null" && region == "null" && turnout == "null")
								g.selectAll(".map")
									.attr("style", "opacity:1")
								
							else
								g.selectAll(".map")
									.attr("id", "filtertime")
									
								if (party == "null")
									g.selectAll("#filtertime")
										.attr("id", "partyfiltered")
								else
									g.selectAll("#filtertime")
										.attr("style", function(d){
											if (party != d.properties.incumbent)
												return "opacity: 0.1";
											})
										.attr("id", function(d){
											if (party == d.properties.incumbent)
												return "partyfiltered"								
											});
																
									
								if (majority == "null")
									g.selectAll("#partyfiltered")
										.attr("id", "majorityfiltered")
								else	
									g.selectAll("#partyfiltered")
										.attr("style", function(d){									
											if (majority == "marginal" && d.properties.info_majorityvotes >= 1000)								
												return "opacity: 0.1";
												
											if (majority == "close" && (d.properties.info_majorityvotes < 1000|| d.properties.info_majorityvotes >= 3000))							
												return "opacity: 0.1";
												
											if (majority == "safeish" && (d.properties.info_majorityvotes < 3000 || d.properties.info_majorityvotes >= 7000))								
												return "opacity: 0.1";
												
											if (majority == "safe" && d.properties.info_majorityvotes < 7000)								
												return "opacity: 0.1";								
											})								
										.attr("id", function(d){									
											if (majority == "marginal" && d.properties.info_majorityvotes < 1000)								
												return "majorityfiltered"
												
											if (majority == "close" && (d.properties.info_majorityvotes >= 1000 && d.properties.info_majorityvotes < 3000))							
												return "majorityfiltered";
												
											if (majority == "safeish" && (d.properties.info_majorityvotes >= 3000 && d.properties.info_majorityvotes < 7000))								
												return "majorityfiltered";
												
											if (majority == "safe" && d.properties.info_majorityvotes >= 7000)								
												return "majorityfiltered";								
											});
										
								if (region == "null")
									g.selectAll("#majorityfiltered")
										.attr("id", "regionfiltered")
								else
									g.selectAll("#majorityfiltered")	
										.attr("style", function(d){																		
											if (region != d.properties.region)								
												return "opacity: 0.1";	
										})
										.attr("id", function(d){																		
											if (region == d.properties.region)								
												return "regionfiltered";		
										});	
										
								if (region == "null")
									g.selectAll("#majorityfiltered")
										.attr("id", "regionfiltered")
								else
									g.selectAll("#majorityfiltered")	
										.attr("style", function(d){																		
											if (region != d.properties.region)								
												return "opacity: 0.1";	
										})
										.attr("id", function(d){																		
											if (region == d.properties.region)								
												return "regionfiltered";		
										});	
								
								
								if (turnout == "null")
									g.selectAll("#regionfiltered")
										.attr("id", "null")
								else
									g.selectAll("#regionfiltered")
										.attr("style", function(d){	
											if (turnout == "low" && d.properties.info_turnout >= 55)								
												return "opacity: 0.1";
												
											if (turnout == "average" && (d.properties.info_turnout < 55|| d.properties.info_turnout >= 65))							
												return "opacity: 0.1";
												
											if (turnout == "high" && (d.properties.info_turnout < 65 || d.properties.info_turnout >= 75))								
												return "opacity: 0.1";
												
											if (turnout == "extreme" && d.properties.info_turnout < 75)								
												return "opacity: 0.1";
									})
										.attr("id", "null");
							});
						}
					
					function resetFilter(){
						d3.json("map.json", function(uk){					
							g.selectAll(".map")
								.attr("style", function(d){								
										return "opacity: 1";
									})	
								
						});
						$("#dropdownparty option:eq(0)").prop("selected", true);
						$("#dropdownmajority option:eq(0)").prop("selected", true);
						$("#dropdownregion option:eq(0)").prop("selected", true);
						$("#dropdownturnout option:eq(0)").prop("selected", true);
						
					}
				</script>
					
				<div id= "placelabels">					
					<button id="placeslabelbutton">Toggle Place Labels</button> 
					<p> doesnt work right now</p>
				</div>
					
				<script>
					$(document).ready(function(){
						$("button#placeslabelbutton").click(function(){
							$(this).toggleClass("checked");
						});
					});
				</script>
				
			</div>
			
			<div id="left">
					<script>
						d3.selection.prototype.moveToFront = function() {
								return this.each(function(){
								this.parentNode.appendChild(this);
							});
						}; 	
					</script>
					
					<script>
						var width = 700, // width and height of map
							height = 900;
							active = d3.select(null);
						
						var projection = d3.geo.albers() // variables to change default map position
							.center([0, 54.6]) //centers vertically and horizontally
							.rotate([3, 0])
							.parallels([51, 60])
							.scale(5400)
							.translate([width / 2, height / 2]);								
						
						var zoom = d3.behavior.zoom()
							.translate([0, 0])
							.scale(1)
							.scaleExtent([1, 25]) // change depth of potential zoom
							.on("zoom", zoomed); // starts zoom function
					
						var path = d3.geo.path()
							.projection(projection)
							.pointRadius(0.3);							
							
						var svg = d3.select("#left").append("svg")
							.attr("width", width)
							.attr("height", height)
							.on("click", stopped, true);
					
						svg.append("rect")
							.attr("class", "background")
							.attr("width", width)
							.attr("height", height)
							.on("click", reset);	
						
					

						var g = svg.append("g");
						
						var previousnode = null;
						
						
						
						svg
							.call(zoom) 
							.call(zoom.event);
							
						var d3map = d3.json("map.json", function(error, uk) {
								if (error) return console.error(error);								
									
								
								
								g.selectAll(".map")
									.data(topojson.feature(uk, uk.objects.map).features)
									.enter().append("path")
									.attr("class", function(d) {
										return "map " + d.properties.incumbent;	})
									.attr("d", path) 			
									/*.on("mouseover", function(){ 
										d3.select(this)
											.style("opacity", 0.7)
										})
									.on("mouseout", function(){ 
										d3.select(this)
											.style("opacity", 1)
										})*/
									.on("click", clicked)									
									.append("svg:title")
										.text(function(d) { return d.properties.name})
									
								g.append("path")
									.datum(topojson.mesh(uk, uk.objects.map, function(a, b){
										return a.properties.region != b.properties.region && a != b; }))
									.attr("d", path)
									.attr("class", "boundaries");
							});
							
						
						
						// code to append place labels - needs working on 
						/*
						
								
							*/		
								
						function clicked(d) {
			
							d3.select(previousnode)
								.style("stroke", "darkgrey")
								.style("stroke-width", 0.1);
								
							
							d3.select(this)
								.moveToFront()
								.transition()
								.style("stroke", "black")
								.style("stroke-width", 0.3);
						
								
							
							
							
							if (active.node() === this) return reset();
							active.classed("active", false);
							active = d3.select(this).classed("active", true);

							var bounds = path.bounds(d),
								dx = bounds[1][0] - bounds[0][0],
								dy = bounds[1][1] - bounds[0][1],
								x = (bounds[0][0] + bounds[1][0]) / 2,
								y = (bounds[0][1] + bounds[1][1]) / 2,
								scale = .25 / Math.max(dx / width, dy / height),
								translate = [width / 2 - scale * x, height / 2 - scale * y];

							svg.transition()
								.duration(1500)
								.call(zoom.translate(translate).scale(scale).event);
							
							
							seatinfo(d);
							previousnode = this;
						
						}
				
						function reset() {
							active.classed("active", false);
							active = d3.select(null);

							svg.transition()
								.duration(1500)
								.call(zoom.translate([0, 0]).scale(1).event);
								
						}

						function zoomed() {
							g.style("stroke-width", 1.5 / d3.event.scale + "px");
							g.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
							
						}
						
						function stopped() {
							if (d3.event.defaultPrevented) d3.event.stopPropagation();
						}
						
					
						
				</script>	
					
			</div>
			
						
			<div id="right">
				<div id="topright">
					<h3 = "information-header"> Information for Selected Seat</h3>	
					<h4>* - by-election contested since 2010</h4>
				</div>
				
				<div id ="information">				
					<table>
						<tr id="information-seatname"></tr>	
					
						<tr id="information-party"></tr>
						<tr id="information-mp"></tr>
						<tr id="information-majority"></tr>
						<tr id="information-electorate"></tr>							
					</table>
				
				<div id="charts"> 
						<div id="information-pie"></div>					
						<div id="information-chart"></div>	
				</div>
					
					<script>
					var oldclass = null;
					
					function seatinfo(d){
						
						$("#information").removeClass(oldclass);		
						$("#information").addClass(d.properties.incumbent).css("opacity", 0.8);				
						$("#information-seatname").html("<td>Seat</td><td style=\"width:380px\"> " + d.properties.name + "<span id =\"information-byelection\"></span></td><td id=\"rightcolumninfotable\">" + regionlist[d.properties.region] + "</td>");
						if (d.properties.info_bielection == "yes")
							$("#information-byelection").html("*");					
						$("#information-party").html("<td>Party</td><td>" + partylist[d.properties.incumbent] + "</td>");
						$("#information-mp").html("<td>MP</td><td>" + d.properties.info_mpfirstname + " " + d.properties.info_mplastname + "</td>");
						$("#information-majority").html("<td>Majority</td><td> " + d.properties.info_majorityvotes  + "  =  " + d.properties.info_majoritypercent + "%</td>");																	
						$("#information-electorate").html("<td>Turnout </td><td>" + d.properties.info_votescast + " = " + d.properties.info_turnout + "%</td><td id=\"rightcolumninfotable\">Electorate: " + d.properties.info_electorate + "</td>");	
						$("#information-pie").html(piechart(d));
						
						oldclass = d.properties.incumbent;
					}
					
					
					
					function piechart(d){
						
						$("#information-pie").empty();
						$("#information-chart").empty();
						
						$("#information-chart").html("<p></p>");
					
						var data = [];
						data.push({ party: "labour", votes: d.properties.info_LAB});
						data.push({ party: "conservative", votes: d.properties.info_CON});
						data.push({ party: "libdems", votes: d.properties.info_LIB});
						data.push({ party: "ukip", votes: d.properties.info_UKIP});
						data.push({ party: "snp", votes: d.properties.info_SNP});
						data.push({ party: "plaidcymru", votes: d.properties.info_PC});
						data.push({ party: "green", votes: d.properties.info_GRN});
						data.push({ party: "other1", votes: d.properties.info_OTH1});
						data.push({ party: "other2", votes: d.properties.info_OTH2});
						
					
						var filterdata = [];
						
						
						$.each(data, function(i){
							if (data[i].votes > 0)
								filterdata.push(data[i]);
						});
						
					
						
						filterdata.sort(function(a, b){						
								return b.votes - a.votes ; 				
						});
						
						
						// better way of doing this?
						
						
						var width = 250,
							height = 250;
							radius = Math.min(width, height) / 2;
							
													
						var arc = d3.svg.arc()
							.outerRadius(radius - 10)
							.innerRadius(0);							
					
						var pie = d3.layout.pie()
							.sort(null)
							.value(function (d) {
								return d.votes;
							});
							
						var svg = d3.select("#information-pie").append("svg")
							.attr("width", width)
							.attr("height", height)
							.append("g")
							.attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

							var g = svg.selectAll(".arc")
								.data(pie(filterdata))
								.enter().append("g")
								.attr("class", "arc");

							g.append("path")
								.attr("d", arc)								
								.attr("class", function(d, i){									
										return filterdata[i].party;									
									});		
						
						// creates table with vote counts/percentages
						$.each(filterdata, function(i){							
							$("#information-chart").append("<tr class=" + filterdata[i].party + " style=\"font-weight: bold;\"><td>" +  
								partylist[filterdata[i].party] + "</td><td>" + filterdata[i].votes + 
								"</td><td>" + (100 * filterdata[i].votes/d.properties.info_votescast).toFixed(2) +  "%</td></tr>")
						})
								
						}
						
						
						
					</script>
				
					<div id = "totals">
						<h3>Total Seats and Votes</h3>
						<table>
							<tr>
								<th>Party</th>
								<th>Seats</th>
								<th>Net</th>
								<th>Votes</th>
								<th>Vote %</th>
							</tr>
						</table>
					</div>
					
					<script>
						
						
						function doStuff(data) {	
						
							$.each(data, function(i){
								$("#totals table").append("<tr class=\"" + data[i].code +"\"><td>" + data[i].party + "</td><td>" + data[i].seats + "</td><td>"
								+ data[i].net + "</td><td>" + (data[i].votes).toLocaleString() + "</td><td>" + data[i].votepercent +"</td></tr>")
							})
						};
						
						function parseData(url, callBack) {
							Papa.parse(url, {
								download: true,
								header: true,								
								dynamicTyping: true,
								complete: function(results) {
									callBack(results.data);
								}
							});
						}

						parseData("votetotals.csv", doStuff);
					
						
					</script>
					
			</div>
		</div>
		
		<div id="footer">	
				<p> Scroll wheel to zoom on map, click to zoom on specific seat, click and drag to pan around the map. Click on the active seat or in the sea to get back to starting zoom.</p>		
		
				<p> Copyright 2015 principalfish.co.uk</p>
		</div>
	
		
		
		
</body>
	
<footer>
	<script>
	  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	  ga('create', 'UA-58696407-1', 'auto');
	  ga('send', 'pageview');

	</script>
</footer>